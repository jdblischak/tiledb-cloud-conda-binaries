name: Create conda environment for notebook python kernel
on:
  push:
    paths:
      - '.github/workflows/create-conda-envs-notebook.yml'
  pull_request:
    paths:
      - '.github/workflows/create-conda-envs-notebook.yml'
  workflow_dispatch:
defaults:
  run:
    shell: bash
jobs:
  python:
    runs-on: ubuntu-latest
    container:
      image: jupyter/minimal-notebook:lab-3.4.5
    steps:
      - name: Remove pinned dependencies from local installation
        run: rm -f "${CONDA_DIR}/conda-meta/pinned"
      - name: Install conda packages
        run: |
          mamba install -y -c tiledb/label/for-cloud -c tiledb -c fastai -c pyviz -c bokeh -c conda-forge \
            python==3.9.* \
            numpy==1.23.* \
            setuptools \
            s3contents \
            nbgitpuller \
            bash_kernel \
            jq \
            awscli \
            vim \
            plotly \
            ipywidgets \
            ipympl \
            yarn \
            graphviz \
            pydot \
            'pandas<2' \
            pyarrow \
            numba \
            jinja2==3.0.* \
            voila==0.3.4 \
            voila-gridstack \
            jupyter-server-proxy \
            opencv-python-headless \
            pytables \
            tree \
            scikit-learn==1.* \
            scikit-misc \
            snowflake-connector-python \
            itables \
            flask \
            flask_cors \
            jupyter_bokeh==3.0.3 \
            jupyter-panel-proxy \
            ipywidgets_bokeh \
            faiss-cpu \
            hnswlib \
            bqplot \
            ipyvuetify \
            scikit-image \
            langchain \
            huggingface_hub \
            openai \
            tiktoken \
            python-dotenv \
            sentence-transformers \
            'fsspec>2022' \
            git-lfs \
            torchvision \
            pytorch==1.12.* \
            pytorch_geometric \
            torchdata==0.4.1 \
            tensorflow-datasets \
            keras-applications \
            tensorflow==2.11.* \
            'cloudpickle<3'
      - name: Export frozen conda environment
        run: conda list --export --explicit --md5 > notebook-python-frozen.yaml
      - name: Upload frozen conda environment as artifact
        uses: actions/upload-artifact@v4
        with:
          name: notebook-python-frozen
          path: notebook-python-frozen.yaml
          if-no-files-found: error
          retention-days: 14
  r:
    runs-on: ubuntu-latest
    container:
      image: jupyter/minimal-notebook:lab-3.4.5
    steps:
      - name: Remove pinned dependencies from local installation
        run: rm -f "${CONDA_DIR}/conda-meta/pinned"
      - name: Create conda environment
        run: |
          mamba create -y -n r-tiledb -c conda-forge -c tiledb/label/for-cloud -c tiledb \
            cmake \
            cxx-compiler \
            r-base==4.2.* \
            r-irkernel \
            r-tidyverse \
            'r-stringi>=1.7.12' \
            r-shiny \
            r-shinybg==0.1.6 \
            r-shinyjs \
            r-shinycssloaders \
            r-shinydashboard \
            r-shinyfeedback \
            r-shinylogs \
            r-plotly \
            r-bslib \
            r-sass \
            r-htmlwidgets \
            r-arrow \
            r-remotes \
            r-xml \
            r-dplyr \
            r-purrr \
            r-jsonlite \
            r-glue \
            r-readr \
            r-crul \
            r-dt \
            r-bslib \
            r-randomcolor \
            r-biocmanager \
            r-reticulate \
            r-ini \
            r-desc \
            r-markdown \
            r-pkgload \
            r-whisker \
            r-sever \
            r-config \
            git-lfs
      - name: Export frozen conda environment
        run: conda list -n r-tiledb --export --explicit --md5 > notebook-r-frozen.yaml
      - name: Upload frozen conda environment as artifact
        uses: actions/upload-artifact@v4
        with:
          name: notebook-r-frozen
          path: notebook-r-frozen.yaml
          if-no-files-found: error
          retention-days: 14
